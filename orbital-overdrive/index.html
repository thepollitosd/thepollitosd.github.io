<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Overdrive - Honors Chemistry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700&display=swap');

        :root {
            --bg-light: #f8fafc;
            --text-main: #334155;
            --accent-blue: #3b82f6;
            --accent-shadow: rgba(59, 130, 246, 0.25);
        }

        *, *::before, *::after {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            overflow-x: hidden;
            height: 100vh;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .font-mono-display { font-family: 'Space Grotesk', monospace; }

        /* Scrollbar styling for panels */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .ptable-wrapper {
            width: 100%;
            height: 100%;
            overflow: auto;
            padding: 1rem;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
        }

        @media (min-width: 1024px) {
            .ptable-wrapper { justify-content: center; align-items: center; }
        }

        .ptable {
            display: grid;
            grid-template-columns: repeat(18, minmax(30px, 42px)); 
            grid-template-rows: repeat(5, minmax(30px, 42px));
            gap: 3px;
            margin: auto;
        }

        .element {
            aspect-ratio: 1/1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            font-weight: 600;
            position: relative;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .element span.symbol { font-size: 1.2em; line-height: 1; font-weight: 800; }
        .element span.number { font-size: 0.6em; opacity: 0.6; position: absolute; top: 1px; left: 2px; }

        .element:hover { transform: scale(1.35); z-index: 50; box-shadow: 0 10px 20px rgba(0,0,0,0.15); border-color: white; }
        
        .element.target-highlight { 
            transform: scale(1.2); z-index: 40; 
            box-shadow: 0 0 0 3px var(--accent-blue);
            background-color: white !important;
            border-color: var(--accent-blue);
        }

        .mode-identify .element:hover {
            border-color: var(--accent-blue);
            cursor: crosshair;
        }

        .block-s { background-color: #fee2e2; color: #dc2626; border-color: #fecaca; }
        .block-p { background-color: #dbeafe; color: #2563eb; border-color: #bfdbfe; }
        .block-d { background-color: #fef3c7; color: #d97706; border-color: #fde68a; }

        .orbital-box {
            width: 32px; height: 32px; border: 2px solid #cbd5e1; border-radius: 6px;
            display: inline-flex; justify-content: center; align-items: center; margin: 1px;
            background: white; transition: all 0.1s; cursor: pointer;
        }
        @media (min-width: 640px) {
            .orbital-box { width: 38px; height: 38px; }
        }
        .orbital-box:hover { border-color: var(--accent-blue); background: #eff6ff; }
        .spin-arrow { font-size: 20px; font-weight: 800; line-height: 1; }

        .config-block {
            padding: 4px 10px; background: white; border: 2px solid #e2e8f0; border-radius: 8px;
            margin: 2px; cursor: pointer; position: relative;
            display: inline-flex; flex-direction: column; align-items: center;
        }
        .config-super { 
            font-size: 0.7rem; background: #eff6ff; color: #2563eb; padding: 0 4px; border-radius: 4px; 
            position: absolute; top: -6px; right: -6px; font-weight: bold; border: 1px solid #dbeafe;
        }

        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .key-btn {
            background: white; border: 1px solid #e2e8f0; border-bottom-width: 3px; border-radius: 0.5rem;
            font-family: 'Space Grotesk', monospace; font-weight: 600; color: #475569;
            display: flex; align-items: center; justify-content: center; min-height: 42px;
            transition: all 0.1s;
            cursor: pointer;
        }
        .key-btn:active { transform: translateY(2px); border-bottom-width: 1px; }
        .key-noble { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }

        #toast { transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease; }
        .toast-visible { transform: translate(-50%, 0) !important; opacity: 1 !important; }
        .toast-hidden { transform: translate(-50%, -150%) !important; opacity: 0 !important; }

        .cursor-blink {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: var(--accent-blue);
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .diagram-scroll-container {
            width: 100%;
            overflow-x: auto;
            padding: 10px 0;
            display: flex;
            justify-content: center;
        }

        /* Dashboard Styles */
        #dashboard {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(248, 250, 252, 0.98);
            backdrop-filter: blur(8px);
            z-index: 100;
        }
        .mode-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 12px;
            padding: 1rem; cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 0.5rem;
            text-align: center;
        }
        .mode-card:hover {
            transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            border-color: var(--accent-blue);
        }
        .mode-icon { font-size: 2rem; }
        
        #timer-bar-container {
            width: 100%; height: 4px; background: #e2e8f0; position: absolute; bottom: 0; left: 0;
        }
        #timer-bar {
            height: 100%; background: var(--accent-blue); width: 100%; transition: width 1s linear;
        }

        /* Nav Tab Active State */
        .dash-nav-btn { position: relative; color: #94a3b8; transition: color 0.2s; }
        .dash-nav-btn.active { color: #2563eb; }
        .dash-nav-btn.active::after {
            content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; background: #2563eb; border-radius: 50%;
        }
        .dash-section { display: none; animation: fadeIn 0.3s ease-out; }
        .dash-section.active { display: flex; }
    </style>
</head>
<body class="p-2 md:p-4 h-screen flex flex-col" oncontextmenu="return false;">

    <!-- DASHBOARD OVERLAY -->
    <div id="dashboard" class="p-4 flex flex-col justify-center items-center">
        
        <!-- Header / Nav -->
        <div class="absolute top-8 text-center w-full">
            <div class="inline-block w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white font-bold text-2xl shadow-lg shadow-blue-200 mb-2">O</div>
            <h1 class="text-3xl font-black text-slate-800 tracking-tighter">ORBITAL <span class="text-blue-600">OVERDRIVE</span></h1>
        </div>

        <!-- Content Containers -->
        <div class="w-full max-w-4xl flex-grow flex flex-col justify-center items-center py-20 overflow-y-auto custom-scroll">
            
            <!-- HOME: Game Modes -->
            <div id="dash-home" class="dash-section active w-full flex-col items-center">
                <p class="text-slate-400 font-bold tracking-widest text-xs uppercase mb-6">Select Simulation Protocol</p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 w-full max-w-2xl mb-8">
                    <button onclick="startGame('Classic')" class="mode-card group">
                        <span class="mode-icon group-hover:scale-110 transition-transform">üé≤</span>
                        <span class="font-bold text-slate-700">Classic</span>
                        <span class="text-xs text-slate-400">Mixed curriculum</span>
                    </button>
                    <button onclick="startGame('Architect')" class="mode-card group">
                        <span class="mode-icon group-hover:scale-110 transition-transform">üèóÔ∏è</span>
                        <span class="font-bold text-slate-700">Architect</span>
                        <span class="text-xs text-slate-400">Electron Configs</span>
                    </button>
                    <button onclick="startGame('Quantum')" class="mode-card group">
                        <span class="mode-icon group-hover:scale-110 transition-transform">üì¶</span>
                        <span class="font-bold text-slate-700">Quantum</span>
                        <span class="text-xs text-slate-400">Orbital Diagrams</span>
                    </button>
                    <button onclick="startGame('Detective')" class="mode-card group">
                        <span class="mode-icon group-hover:scale-110 transition-transform">üîç</span>
                        <span class="font-bold text-slate-700">Detective</span>
                        <span class="text-xs text-slate-400">Identify Elements</span>
                    </button>
                    <button onclick="startGame('Nuclear')" class="mode-card group">
                        <span class="mode-icon group-hover:scale-110 transition-transform">‚öõÔ∏è</span>
                        <span class="font-bold text-slate-700">Nuclear</span>
                        <span class="text-xs text-slate-400">Valence & Isotopes</span>
                    </button>
                    <button onclick="startGame('Trivia')" class="mode-card group">
                        <span class="mode-icon group-hover:scale-110 transition-transform">üß†</span>
                        <span class="font-bold text-slate-700">Trivia</span>
                        <span class="text-xs text-slate-400">Vocabulary</span>
                    </button>
                </div>

                <!-- Settings -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 w-full max-w-md">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Training Parameters</h3>
                    
                    <!-- Timer -->
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm font-bold text-slate-700">Time Limit</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="timer-toggle" class="sr-only peer" onchange="toggleTimerSettings()">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div id="timer-duration-setting" class="flex items-center justify-between opacity-50 pointer-events-none transition-opacity mb-6">
                        <span class="text-sm font-bold text-slate-400 ml-4">Duration</span>
                        <div class="flex gap-2">
                            <button onclick="setTimerDuration(15)" class="t-btn px-3 py-1 rounded border border-slate-200 text-xs font-bold bg-slate-50 hover:bg-white active:bg-blue-50" id="t-15">15s</button>
                            <button onclick="setTimerDuration(30)" class="t-btn px-3 py-1 rounded border border-slate-200 text-xs font-bold bg-slate-50 hover:bg-white active:bg-blue-50" id="t-30">30s</button>
                            <button onclick="setTimerDuration(60)" class="t-btn px-3 py-1 rounded border border-slate-200 text-xs font-bold bg-slate-50 hover:bg-white active:bg-blue-50" id="t-60">60s</button>
                        </div>
                    </div>

                    <!-- Focus Range -->
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm font-bold text-slate-700">Focus Range</span>
                        <div class="flex gap-1">
                            <button onclick="setFocusRange(3)" class="range-btn px-2 py-1 rounded border border-slate-200 text-[10px] font-bold bg-slate-50 hover:bg-white" id="range-3">P 1-3</button>
                            <button onclick="setFocusRange(4)" class="range-btn px-2 py-1 rounded border border-slate-200 text-[10px] font-bold bg-slate-50 hover:bg-white" id="range-4">P 1-4</button>
                            <button onclick="setFocusRange(5)" class="range-btn px-2 py-1 rounded border border-slate-200 text-[10px] font-bold bg-blue-600 text-white border-blue-600" id="range-5">ALL</button>
                        </div>
                    </div>

                    <!-- Pro Mode -->
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-700">Pro Mode</span>
                            <span class="text-[10px] text-slate-400">Hides in-game hints</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="pro-mode-toggle" class="sr-only peer" onchange="toggleProMode()">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                    </div>

                </div>
            </div>

            <!-- ABOUT -->
            <div id="dash-about" class="dash-section w-full max-w-2xl flex-col gap-6">
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">About the Simulation</h2>
                    <p class="text-slate-600 mb-4 leading-relaxed">
                        Orbital Overdrive is an interactive training module designed for Honors Chemistry students to master the fundamental principles of atomic structure.
                    </p>
                    <p class="text-slate-600 mb-4 leading-relaxed">
                        Through gamified drills, users practice writing electron configurations (Standard & Shorthand), constructing orbital diagrams according to Hund's Rule and the Pauli Exclusion Principle, and identifying periodic trends.
                    </p>
                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                        <h3 class="font-bold text-slate-700 mb-2 text-sm">Key Concepts Covered</h3>
                        <ul class="list-disc list-inside text-sm text-slate-500 space-y-1">
                            <li>Aufbau Principle & Orbital Filling</li>
                            <li>Exceptional Configurations (Cr, Cu, Mo, Ag, Pd)</li>
                            <li>Isotope Mass & Valence Electrons</li>
                            <li>Periodic Groups & Families</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- HISTORY -->
            <div id="dash-history" class="dash-section w-full max-w-2xl flex-col gap-4">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                    <div class="flex justify-between items-baseline mb-2">
                        <h3 class="text-lg font-bold text-slate-800">v1.4 <span class="text-blue-500">b.1</span></h3>
                        <span class="text-xs font-bold bg-blue-100 text-blue-600 px-2 py-1 rounded">CURRENT</span>
                    </div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">QUANTUM TUNING</p>
                    <ul class="text-sm text-slate-600 space-y-1 list-disc list-inside">
                        <li>New "Focus Range" setting: Limit elements to Period 3, 4, or 5</li>
                        <li>New "Pro Mode": Hides game hints for extra challenge</li>
                        <li>Updated dashboard UI with more training parameters</li>
                    </ul>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 opacity-75">
                    <h3 class="text-lg font-bold text-slate-800 mb-1">v1.3 <span class="text-slate-400">b.4</span></h3>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">ATOMIC DASHBOARD</p>
                    <ul class="text-sm text-slate-600 space-y-1 list-disc list-inside">
                        <li>Fixed: Time's Up now reveals and explains the correct answer</li>
                        <li>Balanced: Detective Mode now favors Electron Config identification (40%)</li>
                        <li>UI: Added rich text formatting for solution explanations</li>
                        <li>Fixed: Dashboard layer blocking game interaction</li>
                    </ul>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 opacity-60">
                    <h3 class="text-lg font-bold text-slate-800 mb-1">v1.2 <span class="text-slate-400">b.1</span></h3>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">MOLECULAR MIND</p>
                    <ul class="text-sm text-slate-600 space-y-1 list-disc list-inside">
                        <li>Massively expanded Vocabulary bank (25+ terms)</li>
                        <li>Added new trivia categories for Quantum Rules</li>
                        <li>Improved mobile scaling for diagrams</li>
                    </ul>
                </div>
            </div>

            <!-- DEV NOTES -->
            <div id="dash-dev" class="dash-section w-full max-w-2xl flex-col gap-6">
                <div class="bg-slate-900 p-8 rounded-3xl shadow-lg border border-slate-800 text-slate-300 font-mono text-sm leading-relaxed">
                    <h2 class="text-xl font-bold text-white mb-4">// DEVELOPER LOG</h2>
                    <div class="mb-6">
                        <h3 class="text-blue-400 font-bold mb-2">> TECH_STACK</h3>
                        <p>Built with vanilla HTML5/JS and TailwindCSS. No external frameworks used to ensure lightweight performance on school devices.</p>
                    </div>
                    <div>
                        <h3 class="text-blue-400 font-bold mb-2">> KNOWN_LIMITATIONS</h3>
                        <p>1. f-block elements are currently excluded to maintain UI grid stability on mobile.</p>
                        <p>2. Orbital diagrams use a simplified box model. Spin quantum numbers are visualized as arrows but strictly enforced only by count.</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Dashboard Nav -->
        <div class="absolute bottom-8 flex gap-8">
            <button onclick="switchDash('home')" id="nav-home" class="dash-nav-btn active font-bold uppercase tracking-widest text-xs">Play</button>
            <button onclick="switchDash('about')" id="nav-about" class="dash-nav-btn font-bold uppercase tracking-widest text-xs">About</button>
            <button onclick="switchDash('history')" id="nav-history" class="dash-nav-btn font-bold uppercase tracking-widest text-xs">History</button>
            <button onclick="switchDash('dev')" id="nav-dev" class="dash-nav-btn font-bold uppercase tracking-widest text-xs">Dev Notes</button>
        </div>
    </div>

    <!-- MAIN GAME UI (Hidden by Dashboard initially) -->
    <nav class="flex-none flex flex-col md:flex-row justify-between items-center bg-white p-3 md:p-4 rounded-xl shadow-sm border border-slate-200 mb-2 mx-auto w-full max-w-[1400px] gap-2">
        <div class="flex items-center gap-3">
            <button onclick="showDashboard()" class="p-2 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors" title="Back to Menu">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <div class="leading-tight cursor-pointer" onclick="showDashboard()">
                <h1 class="text-xl font-bold tracking-tight text-slate-800">ORBITAL <span class="text-blue-600">OVERDRIVE</span></h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Honors Chemistry</p>
            </div>
        </div>
        
        <div class="flex gap-4 md:gap-8 text-center bg-slate-50 p-2 rounded-lg border border-slate-100">
            <div>
                <p class="text-[10px] text-slate-400 font-bold uppercase">Streak</p>
                <p id="streak-val" class="text-lg font-mono-display font-bold text-orange-500">0</p>
            </div>
            <div>
                <p class="text-[10px] text-slate-400 font-bold uppercase">Score</p>
                <p id="score-val" class="text-lg font-mono-display font-bold text-emerald-500">0</p>
            </div>
            <div>
                <p class="text-[10px] text-slate-400 font-bold uppercase">Level</p>
                <p id="level-val" class="text-lg font-mono-display font-bold text-blue-500">1</p>
            </div>
        </div>
    </nav>

    <div class="flex-grow grid grid-cols-1 lg:grid-cols-12 gap-2 md:gap-4 max-w-[1400px] mx-auto w-full overflow-hidden">
        
        <!-- PERIODIC TABLE AREA -->
        <div class="lg:col-span-7 bg-white rounded-2xl shadow-md border border-slate-100 flex flex-col order-2 lg:order-1 relative h-full overflow-hidden">
            <div class="flex-none flex justify-between items-end p-3 pb-0">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Periodic Table</h3>
                <div id="table-instruction" class="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded hidden animate-pulse">Select Element</div>
            </div>
            
            <div class="ptable-wrapper">
                <div id="ptable-container" class="ptable"></div>
            </div>
        </div>

        <!-- INTERACTION SIDEBAR -->
        <div class="lg:col-span-5 flex flex-col gap-2 md:gap-4 order-1 lg:order-2 h-full overflow-y-auto pb-4">
            
            <div id="prompt-card" class="bg-white p-4 md:p-6 rounded-2xl shadow-lg border border-blue-50 text-center relative overflow-hidden min-h-[160px] flex flex-col justify-center items-center transition-all flex-none">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500"></div>
                <div id="timer-bar-container" class="hidden">
                    <div id="timer-bar"></div>
                </div>
                
                <div class="absolute top-3 left-0 w-full flex justify-between px-4 items-center">
                    <span id="prompt-label" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Target</span>
                    <div id="mode-badge" class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-lg text-sm font-bold text-slate-700 shadow-sm border border-slate-200">
                        <div class="w-2.5 h-2.5 rounded-full bg-blue-500"></div> Standard
                    </div>
                </div>

                <div id="prompt-content" class="w-full mt-6"></div>
            </div>

            <!-- SUCCESS PANEL -->
            <div id="info-panel" class="hidden bg-emerald-50 border border-emerald-100 p-4 rounded-xl fade-in flex-none">
                <div class="flex gap-3">
                    <div class="text-2xl">üí°</div>
                    <div class="flex-grow">
                        <h4 class="text-sm font-bold text-emerald-800" id="info-title">Fact</h4>
                        <p class="text-xs text-emerald-700 mt-1 leading-relaxed" id="info-desc">...</p>
                        <button onclick="nextLevel()" class="w-full mt-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 rounded-lg text-sm shadow-sm transition-colors">
                            Next Challenge ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <!-- THE TYPING / INPUT WINDOW -->
            <div id="input-area" class="bg-white p-4 rounded-2xl shadow-md border border-slate-100 flex-grow flex flex-col relative transition-all min-h-[260px]">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xs font-bold text-slate-500 uppercase">Input Window</h4>
                    <button onclick="resetInput()" id="btn-reset" class="text-[10px] font-bold text-red-400 hover:text-red-500 uppercase hover:bg-red-50 px-2 py-1 rounded">Reset</button>
                </div>

                <!-- 1. Configuration Builder -->
                <div id="builder-ui" class="hidden flex-col gap-3 h-full">
                    <div id="config-output" class="min-h-[60px] bg-slate-50 border-2 border-slate-200 border-dashed rounded-xl p-3 flex flex-wrap gap-1 items-center content-center justify-center"></div>
                    <div class="grid grid-cols-5 gap-1.5" id="orbital-keypad"></div>
                </div>

                <!-- 2. Numeric Window -->
                <div id="numeric-ui" class="hidden flex-col gap-3 h-full">
                    <div class="flex justify-center mb-2">
                        <div class="bg-slate-50 border-2 border-slate-200 rounded-xl px-6 py-2 flex items-center min-w-[120px] justify-center">
                            <span id="numeric-display" class="text-4xl font-mono font-bold text-slate-800"></span>
                            <span class="cursor-blink"></span>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 flex-grow" id="numeric-keys"></div>
                </div>

                <!-- 3. Vocabulary Quiz Window -->
                <div id="quiz-ui" class="hidden flex-col gap-2 h-full justify-center"></div>

                <!-- 4. Orbital Diagram Window -->
                <div id="diagram-ui" class="hidden flex-col items-center">
                    <div class="diagram-scroll-container">
                         <div id="orbital-diagram-grid" class="flex flex-wrap gap-y-4 gap-x-2 justify-center max-w-full"></div>
                    </div>
                    <p id="diagram-hint" class="text-[10px] text-slate-400 mt-2 italic font-medium uppercase tracking-widest text-center">Click boxes to add/remove electrons</p>
                </div>

                <!-- Common Submit -->
                <div class="mt-auto pt-4" id="submit-wrapper">
                    <button id="submit-btn" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold tracking-wide hover:bg-slate-800 active:scale-95 transition-all shadow-lg flex items-center justify-center gap-2">
                        <span>CONFIRM ANSWER</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </button>
                </div>
            </div>

            <!-- HUNT / IDENTIFY PROMPT -->
            <div id="identify-hint" class="hidden bg-slate-50 p-6 rounded-2xl border-2 border-dashed border-slate-200 text-center flex-col justify-center items-center h-full">
                <div class="text-4xl mb-2">üëÜ</div>
                <h3 class="text-slate-800 font-bold">Select on Table</h3>
                <p class="text-sm text-slate-500 mt-2" id="hunt-msg">Find the correct element to answer.</p>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-24 left-1/2 px-6 py-4 bg-white rounded-full shadow-2xl border border-slate-100 flex items-center gap-3 z-[60] pointer-events-none toast-hidden">
        <div id="toast-icon" class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-bold">‚úì</div>
        <div>
            <p id="toast-title" class="font-bold text-sm text-slate-800">Correct!</p>
            <p id="toast-msg" class="text-xs text-slate-500">Streak +1</p>
        </div>
    </div>

    <!-- VERSION FOOTER -->
    <div class="fixed bottom-1 right-2 text-[10px] font-mono text-slate-400 opacity-60 pointer-events-none select-none z-50">
        ORBITAL_OS <span class="font-bold">v1.4</span> <span class="text-blue-400">b.1</span> [QUANTUM TUNING]
    </div>

    <script>
        // --- COMPLETE ELEMENTS LIST (1-54) ---
        const elements = [
            // Period 1
            {z: 1, s: "H", n: "Hydrogen", b: "s", d: "Most abundant element in the universe.", v:1},
            {z: 2, s: "He", n: "Helium", b: "s", d: "Inert noble gas used in balloons.", v:2},
            // Period 2
            {z: 3, s: "Li", n: "Lithium", b: "s", d: "Lightest metal, used in batteries.", v:1},
            {z: 4, s: "Be", n: "Beryllium", b: "s", d: "Lightweight aerospace metal.", v:2},
            {z: 5, s: "B", n: "Boron", b: "p", d: "Metalloid used in heat-resistant glass.", v:3},
            {z: 6, s: "C", n: "Carbon", b: "p", d: "Basis of organic life.", v:4},
            {z: 7, s: "N", n: "Nitrogen", b: "p", d: "78% of Earth's atmosphere.", v:5},
            {z: 8, s: "O", n: "Oxygen", b: "p", d: "Essential for respiration.", v:6},
            {z: 9, s: "F", n: "Fluorine", b: "p", d: "Most reactive element.", v:7},
            {z: 10, s: "Ne", n: "Neon", b: "p", d: "Noble gas that glows red-orange.", v:8},
            // Period 3
            {z: 11, s: "Na", n: "Sodium", b: "s", d: "Explodes in water, forms salt.", v:1},
            {z: 12, s: "Mg", n: "Magnesium", b: "s", d: "Burns with bright white light.", v:2},
            {z: 13, s: "Al", n: "Aluminum", b: "p", d: "Most abundant metal in crust.", v:3},
            {z: 14, s: "Si", n: "Silicon", b: "p", d: "Foundation of computer chips.", v:4},
            {z: 15, s: "P", n: "Phosphorus", b: "p", d: "Essential for ATP and DNA.", v:5},
            {z: 16, s: "S", n: "Sulfur", b: "p", d: "Yellow solid, smells like rotten eggs.", v:6},
            {z: 17, s: "Cl", n: "Chlorine", b: "p", d: "Toxic gas used in pools.", v:7},
            {z: 18, s: "Ar", n: "Argon", b: "p", d: "3rd most abundant atmospheric gas.", v:8},
            // Period 4
            {z: 19, s: "K", n: "Potassium", b: "s", d: "Vital nutrient for nerves.", v:1},
            {z: 20, s: "Ca", n: "Calcium", b: "s", d: "Essential for bones and teeth.", v:2},
            {z: 21, s: "Sc", n: "Scandium", b: "d", d: "Used in stadium lights.", v:null},
            {z: 22, s: "Ti", n: "Titanium", b: "d", d: "Strong as steel, light as aluminum.", v:null},
            {z: 23, s: "V", n: "Vanadium", b: "d", d: "Used to harden steel tools.", v:null},
            {z: 24, s: "Cr", n: "Chromium", b: "d", d: "Exception alert: [Ar] 4s1 3d5.", v:null},
            {z: 25, s: "Mn", n: "Manganese", b: "d", d: "Crucial for steel making.", v:null},
            {z: 26, s: "Fe", n: "Iron", b: "d", d: "Core of the Earth.", v:null},
            {z: 27, s: "Co", n: "Cobalt", b: "d", d: "Used in magnets and blue glass.", v:null},
            {z: 28, s: "Ni", n: "Nickel", b: "d", d: "Used in coins and batteries.", v:null},
            {z: 29, s: "Cu", n: "Copper", b: "d", d: "Exception alert: [Ar] 4s1 3d10.", v:null},
            {z: 30, s: "Zn", n: "Zinc", b: "d", d: "Galvanizes steel.", v:null},
            {z: 31, s: "Ga", n: "Gallium", b: "p", d: "Metal that melts in your hand.", v:3},
            {z: 32, s: "Ge", n: "Germanium", b: "p", d: "Semiconductor used in transistors.", v:4},
            {z: 33, s: "As", n: "Arsenic", b: "p", d: "Historically famous poison.", v:5},
            {z: 34, s: "Se", n: "Selenium", b: "p", d: "Photoconductive metalloid.", v:6},
            {z: 35, s: "Br", n: "Bromine", b: "p", d: "Red-brown liquid halogen.", v:7},
            {z: 36, s: "Kr", n: "Krypton", b: "p", d: "Inert gas used in flash bulbs.", v:8},
            // Period 5
            {z: 37, s: "Rb", n: "Rubidium", b: "s", d: "Highly reactive alkali metal.", v:1},
            {z: 38, s: "Sr", n: "Strontium", b: "s", d: "Gives fireworks a red color.", v:2},
            {z: 39, s: "Y", n: "Yttrium", b: "d", d: "Used in LEDs and superconductors.", v:null},
            {z: 40, s: "Zr", n: "Zirconium", b: "d", d: "Used in nuclear reactors.", v:null},
            {z: 41, s: "Nb", n: "Niobium", b: "d", d: "Used in jet engines.", v:null},
            {z: 42, s: "Mo", n: "Molybdenum", b: "d", d: "Exception: [Kr] 5s1 4d5.", v:null},
            {z: 43, s: "Tc", n: "Technetium", b: "d", d: "First artificially produced element.", v:null},
            {z: 44, s: "Ru", n: "Ruthenium", b: "d", d: "Rare metal used in electronics.", v:null},
            {z: 45, s: "Rh", n: "Rhodium", b: "d", d: "Rarest non-radioactive metal.", v:null},
            {z: 46, s: "Pd", n: "Palladium", b: "d", d: "Exception: [Kr] 4d10.", v:null},
            {z: 47, s: "Ag", n: "Silver", b: "d", d: "Exception: [Kr] 5s1 4d10.", v:null},
            {z: 48, s: "Cd", n: "Cadmium", b: "d", d: "Toxic metal used in batteries.", v:null},
            {z: 49, s: "In", n: "Indium", b: "p", d: "Used in touchscreens.", v:3},
            {z: 50, s: "Sn", n: "Tin", b: "p", d: "Alloyed with copper to make bronze.", v:4},
            {z: 51, s: "Sb", n: "Antimony", b: "p", d: "Used in flame retardants.", v:5},
            {z: 52, s: "Te", n: "Tellurium", b: "p", d: "One of the rarest metalloids.", v:6},
            {z: 53, s: "I", n: "Iodine", b: "p", d: "Vital for hormone production.", v:7},
            {z: 54, s: "Xe", n: "Xenon", b: "p", d: "Noble gas used in ion thrusters.", v:8}
        ];

        const vocabBank = [
            { q: "Positive ions are called...", a: "Cations", opts: ["Cations", "Anions", "Protons", "Neutrons"] },
            { q: "Horizontal rows are called...", a: "Periods", opts: ["Groups", "Periods", "Blocks", "Families"] },
            { q: "Halogens belong to which group?", a: "17", opts: ["1", "2", "17", "18"] },
            { q: "Valence electrons are located in...", a: "Outer shell", opts: ["Outer shell", "Nucleus", "Inner shell", "Core"] }
        ];

        const orbitalKeys = ["1s", "2s", "2p", "3s", "3p", "4s", "3d", "4p", "5s", "4d", "5p"];
        const nobleGases = [{z:2,s:"He"},{z:10,s:"Ne"},{z:18,s:"Ar"},{z:36,s:"Kr"},{z:54,s:"Xe"}];

        let state = {
            element: null,
            targetCategory: null,
            vocabQ: null,
            mode: 'build_normal',
            gameType: 'Classic', 
            streak: 0,
            score: 0,
            level: 1,
            userParts: [],
            userNum: "",
            diagram: [],
            waitingNext: false,
            isotopeNeutrons: 0,
            
            // Timer Props
            timerEnabled: false,
            timerDuration: 30, // seconds
            timeLeft: 30,
            timerId: null,

            // New Training Params
            periodLimit: 5, // 3, 4, or 5
            proMode: false  // If true, hides hints
        };

        const huntCategories = {
            alkali: { name: "Alkali Metal", z: [3, 11, 19, 37] },
            alkaline: { name: "Alkaline Earth", z: [4, 12, 20, 38] },
            halogen: { name: "Halogen", z: [9, 17, 35, 53] },
            noble: { name: "Noble Gas", z: [2, 10, 18, 36, 54] },
            transition: { name: "Transition Metal", z: [21,22,23,24,25,26,27,28,29,30,39,40,41,42,43,44,45,46,47,48] },
            metalloid: { name: "Metalloid", z: [5, 14, 32, 33, 51, 52] }
        };

        // --- DASHBOARD LOGIC ---
        function toggleTimerSettings() {
            const enabled = document.getElementById('timer-toggle').checked;
            state.timerEnabled = enabled;
            const settings = document.getElementById('timer-duration-setting');
            if(enabled) settings.classList.remove('opacity-50', 'pointer-events-none');
            else settings.classList.add('opacity-50', 'pointer-events-none');
        }

        function setTimerDuration(sec) {
            state.timerDuration = sec;
            [15,30,60].forEach(s => {
                const btn = document.getElementById(`t-${s}`);
                if(s === sec) {
                    btn.classList.remove('bg-slate-50', 'hover:bg-white');
                    btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                } else {
                    btn.classList.add('bg-slate-50', 'hover:bg-white');
                    btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                }
            });
        }

        function setFocusRange(limit) {
            state.periodLimit = limit;
            [3,4,5].forEach(l => {
                const btn = document.getElementById(`range-${l}`);
                if(l === limit) {
                    btn.classList.remove('bg-slate-50', 'hover:bg-white');
                    btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                } else {
                    btn.classList.add('bg-slate-50', 'hover:bg-white');
                    btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                }
            });
        }

        function toggleProMode() {
            state.proMode = document.getElementById('pro-mode-toggle').checked;
        }

        function showDashboard() {
            clearInterval(state.timerId);
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('flex');
        }

        function switchDash(section) {
            document.querySelectorAll('.dash-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.dash-nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`dash-${section}`).classList.add('active');
            document.getElementById(`nav-${section}`).classList.add('active');
        }

        function startGame(type) {
            state.gameType = type;
            state.score = 0;
            state.streak = 0;
            state.level = 1;
            updateStats();
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('flex');
            nextLevel();
        }

        function startTimer() {
            clearInterval(state.timerId);
            if(!state.timerEnabled) {
                document.getElementById('timer-bar-container').classList.add('hidden');
                return;
            }
            document.getElementById('timer-bar-container').classList.remove('hidden');
            const bar = document.getElementById('timer-bar');
            state.timeLeft = state.timerDuration;
            bar.style.transition = 'none';
            bar.style.width = '100%';
            void bar.offsetWidth;
            bar.style.transition = `width ${state.timerDuration}s linear`;
            bar.style.width = '0%';
            state.timerId = setInterval(() => {
                state.timeLeft--;
                if(state.timeLeft <= 0) {
                    clearInterval(state.timerId);
                    revealAnswer("Time's Up!");
                }
            }, 1000);
        }

        // --- Core Functions ---
        function getCorrectConfig(z, mode) {
            let electrons = z;
            let parts = [];
            let noble = null;
            let isShort = mode.includes('short') || mode === 'identify_config';

            if (isShort) {
                for (let i = nobleGases.length - 1; i >= 0; i--) {
                    if (nobleGases[i].z < z) {
                        noble = nobleGases[i];
                        electrons -= noble.z;
                        break;
                    }
                }
            }

            let order = [
                {n:"1s",max:2},{n:"2s",max:2},{n:"2p",max:6},{n:"3s",max:2},{n:"3p",max:6},
                {n:"4s",max:2},{n:"3d",max:10},{n:"4p",max:6},{n:"5s",max:2},{n:"4d",max:10},{n:"5p",max:6}
            ];
            
            if (noble) {
                if(noble.s==='He') order=order.slice(1);
                if(noble.s==='Ne') order=order.slice(3);
                if(noble.s==='Ar') order=order.slice(5);
                if(noble.s==='Kr') order=order.slice(8);
            }

            for (let orb of order) {
                if(electrons <= 0) break;
                let fill = Math.min(electrons, orb.max);
                if((z===24||z===29||z===47) && orb.n.endsWith('s') && electrons >= orb.max) fill = 1;
                if((z===24) && orb.n==='3d' && fill===4) fill=5;
                if((z===29||z===47) && orb.n.endsWith('d') && fill===9) fill=10;
                if(z===46) { if(orb.n==='5s') fill=0; if(orb.n==='4d') fill=10; } 

                if(fill > 0) parts.push({label:orb.n, count:fill});
                electrons -= fill;
            }
            return { noble: noble ? `[${noble.s}]` : null, parts };
        }

        function renderPTable() {
            const container = document.getElementById('ptable-container');
            container.innerHTML = '';
            const gridMap = {};
            elements.forEach(e => {
                let r, c;
                if (e.z === 1) { r=1; c=1; }
                else if (e.z === 2) { r=1; c=18; }
                else if (e.z <= 10) { r=2; c = e.z <= 4 ? (e.z-2) : (e.z+8); }
                else if (e.z <= 18) { r=3; c = e.z <= 12 ? (e.z-10) : (e.z); }
                else if (e.z <= 36) { r=4; c = e.z-18; }
                else if (e.z <= 54) { r=5; c = e.z-36; }
                gridMap[`${r}-${c}`] = e;
            });

            for (let r=1; r<=5; r++) {
                for (let c=1; c<=18; c++) {
                    const el = gridMap[`${r}-${c}`];
                    const div = document.createElement('div');
                    if (el) {
                        div.className = `element block-${el.b}`;
                        div.id = `el-${el.z}`;
                        div.innerHTML = `<span class="number">${el.z}</span><span class="symbol">${el.s}</span>`;
                        div.onclick = () => handleElementClick(el);
                    } else {
                        div.className = 'opacity-0 pointer-events-none';
                    }
                    container.appendChild(div);
                }
            }
        }

        function setMode() {
            const uis = ['builder-ui', 'numeric-ui', 'quiz-ui', 'diagram-ui', 'identify-hint', 'info-panel'];
            uis.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('input-area').classList.remove('hidden');
            document.getElementById('submit-wrapper').classList.remove('hidden');
            document.querySelectorAll('.element').forEach(e => e.classList.remove('target-highlight'));
            document.getElementById('ptable-container').classList.remove('mode-identify');
            document.getElementById('table-instruction').classList.add('hidden');
            
            if (state.gameType === 'Classic') {
                const modes = ['build_normal', 'build_short', 'build_diagram', 'identify_config', 'identify_diagram', 'count_valence', 'calc_neutrons', 'vocab'];
                state.mode = modes[Math.floor(Math.random() * modes.length)];
            } else if (state.gameType === 'Architect') {
                state.mode = Math.random() > 0.5 ? 'build_normal' : 'build_short';
            } else if (state.gameType === 'Quantum') {
                state.mode = 'build_diagram';
            } else if (state.gameType === 'Detective') {
                if(Math.random() < 0.4) state.mode = 'identify_config';
                else {
                    const modes = ['identify_diagram', 'hunt_alkali', 'hunt_alkaline', 'hunt_halogen', 'hunt_noble', 'hunt_transition', 'hunt_metalloid'];
                    state.mode = modes[Math.floor(Math.random() * modes.length)];
                }
            } else if (state.gameType === 'Nuclear') {
                state.mode = Math.random() > 0.5 ? 'count_valence' : 'calc_neutrons';
            } else if (state.gameType === 'Trivia') {
                state.mode = 'vocab';
            }

            state.waitingNext = false;
            state.userParts = [];
            state.userNum = "";
            state.diagram = [];

            const badge = document.getElementById('mode-badge');
            const promptContent = document.getElementById('prompt-content');
            
            startTimer();

            // PRO MODE CHECK
            if(state.proMode) {
                document.getElementById('diagram-hint').classList.add('hidden');
                document.getElementById('hunt-msg').classList.add('hidden');
            } else {
                document.getElementById('diagram-hint').classList.remove('hidden');
                document.getElementById('hunt-msg').classList.remove('hidden');
            }

            switch(state.mode) {
                case 'build_normal':
                case 'build_short':
                    badge.innerHTML = `<div class="w-2.5 h-2.5 rounded-full bg-blue-500"></div> Configuration`;
                    promptContent.innerHTML = `<div class="text-6xl font-black text-slate-800">${state.element.s}</div><div class="text-lg text-slate-500">${state.element.n}</div>`;
                    document.getElementById('builder-ui').classList.remove('hidden');
                    document.getElementById('builder-ui').classList.add('flex');
                    renderBuilder();
                    highlightElement();
                    break;
                case 'build_diagram':
                    badge.innerHTML = `<div class="w-2.5 h-2.5 rounded-full bg-orange-500"></div> Diagramming`;
                    promptContent.innerHTML = `<div class="text-6xl font-black text-slate-800">${state.element.s}</div><div class="text-lg text-slate-500">${state.element.n}</div>`;
                    document.getElementById('diagram-ui').classList.remove('hidden');
                    document.getElementById('diagram-ui').classList.add('flex');
                    renderDiagramInput();
                    highlightElement();
                    break;
                case 'identify_config':
                case 'identify_diagram':
                    badge.innerHTML = `<div class="w-2.5 h-2.5 rounded-full bg-pink-500"></div> Identify`;
                    document.getElementById('input-area').classList.add('hidden');
                    document.getElementById('identify-hint').classList.remove('hidden');
                    document.getElementById('identify-hint').classList.add('flex');
                    document.getElementById('ptable-container').classList.add('mode-identify');
                    if(!state.proMode) document.getElementById('table-instruction').classList.remove('hidden');
                    if(state.mode === 'identify_config') {
                        const sol = getCorrectConfig(state.element.z, 'short');
                        let str = (sol.noble ? sol.noble + " " : "") + sol.parts.map(p => `${p.label}<sup>${p.count}</sup>`).join(" ");
                        promptContent.innerHTML = `<div class="text-xl font-mono text-slate-700 bg-slate-100 p-4 rounded-xl shadow-inner">${str}</div>`;
                    } else {
                        promptContent.innerHTML = `<div id="diagram-preview" class="flex flex-wrap gap-2 justify-center p-2 rounded-xl bg-slate-50 border border-slate-100"></div>`;
                        renderDiagramPreview(state.element.z);
                    }
                    break;
                case 'count_valence':
                    while(state.element.v === null) state.element = elements[Math.floor(Math.random() * elements.length)];
                    badge.innerHTML = `<div class="w-2.5 h-2.5 rounded-full bg-teal-500"></div> Valence`;
                    promptContent.innerHTML = `<div class="text-6xl font-black text-slate-800 mb-1">${state.element.s}</div><div class="text-lg text-slate-500">${state.element.n}</div>`;
                    document.getElementById('numeric-ui').classList.remove('hidden');
                    renderNumericKeys();
                    break;
                case 'calc_neutrons':
                    badge.innerHTML = `<div class="w-2.5 h-2.5 rounded-full bg-indigo-500"></div> Neutrons`;
                    state.isotopeNeutrons = state.element.z + Math.floor(Math.random() * 5);
                    const mass = state.element.z + state.isotopeNeutrons;
                    promptContent.innerHTML = `<div class="relative inline-block"><span class="absolute -top-1 -left-5 text-xs font-bold text-slate-400">${mass}</span><div class="text-6xl font-black text-slate-800">${state.element.s}</div></div><p class="mt-2 text-slate-400 font-bold uppercase text-[10px]">Find Neutrons</p>`;
                    document.getElementById('numeric-ui').classList.remove('hidden');
                    renderNumericKeys();
                    break;
                case 'vocab':
                    badge.innerHTML = `<div class="w-2.5 h-2.5 rounded-full bg-yellow-500"></div> Terminology`;
                    state.vocabQ = vocabBank[Math.floor(Math.random() * vocabBank.length)];
                    promptContent.innerHTML = `<div class="text-lg font-bold text-slate-700 p-2">${state.vocabQ.q}</div>`;
                    document.getElementById('quiz-ui').classList.remove('hidden');
                    document.getElementById('submit-wrapper').classList.add('hidden');
                    renderVocabQuiz();
                    break;
            }
            
            if(state.mode.startsWith('hunt')) {
                const t = state.mode.split('_')[1];
                state.targetCategory = huntCategories[t];
                
                document.getElementById('input-area').classList.add('hidden');
                document.getElementById('identify-hint').classList.remove('hidden');
                document.getElementById('identify-hint').classList.add('flex');
                document.getElementById('ptable-container').classList.add('mode-identify');
                if(!state.proMode) document.getElementById('table-instruction').classList.remove('hidden');
                
                badge.innerHTML = `<div class="w-2.5 h-2.5 rounded-full bg-emerald-500"></div> Hunt`;
                if(!state.proMode) document.getElementById('hunt-msg').innerHTML = `Find any <b>${state.targetCategory.name}</b>.`;
                promptContent.innerHTML = `
                    <div class="fade-in text-center flex flex-col items-center justify-center h-[80px]">
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">FIND A</div>
                        <div class="text-2xl font-black text-slate-800 tracking-tight leading-none">${state.targetCategory.name}</div>
                    </div>`;
            }
        }

        function highlightElement() {
            if(state.proMode) return; // Hide highlight in Pro Mode
            const el = document.getElementById(`el-${state.element.z}`);
            if(el) {
                el.classList.add('target-highlight');
                el.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
            }
        }

        function renderBuilder() {
            const out = document.getElementById('config-output');
            const keypad = document.getElementById('orbital-keypad');
            out.innerHTML = state.userParts.length ? '' : '<span class="text-slate-400 text-xs italic">Assemble the configuration here...</span>';
            keypad.innerHTML = '';

            if (state.mode === 'build_short') {
                ["[He]", "[Ne]", "[Ar]", "[Kr]"].forEach(n => {
                    const b = document.createElement('button');
                    b.className = "key-btn key-noble text-xs";
                    b.innerText = n;
                    b.onclick = () => addConfigPart(n, true);
                    keypad.appendChild(b);
                });
            }
            orbitalKeys.forEach(k => {
                const b = document.createElement('button');
                b.className = "key-btn text-xs";
                b.innerText = k;
                b.onclick = () => addConfigPart(k, false);
                keypad.appendChild(b);
            });
        }

        function addConfigPart(label, isNoble) {
            if(state.waitingNext) return;
            if(isNoble) {
                state.userParts = state.userParts.filter(p => !p.isNoble);
                state.userParts.unshift({label, isNoble:true});
            } else {
                const type = label.charAt(1);
                const max = type==='s'?2:type==='p'?6:type==='d'?10:14;
                const exist = state.userParts.find(p => p.label === label);
                if(exist) exist.count = (exist.count % max) + 1;
                else state.userParts.push({label, count:1, isNoble:false});
            }
            updateConfigDisplay();
        }

        function updateConfigDisplay() {
            const out = document.getElementById('config-output');
            out.innerHTML = '';
            state.userParts.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = "config-block fade-in" + (p.isNoble ? " bg-slate-800 text-white border-slate-900" : "");
                div.innerHTML = `<span class="font-mono font-bold">${p.label}</span>${!p.isNoble?`<span class="config-super">${p.count}</span>`:''}`;
                div.onclick = () => { state.userParts.splice(i, 1); updateConfigDisplay(); };
                out.appendChild(div);
            });
        }

        function renderNumericKeys() {
            const keypad = document.getElementById('numeric-keys');
            keypad.innerHTML = '';
            document.getElementById('numeric-display').innerText = "";
            [1,2,3,4,5,6,7,8,9,0].forEach(n => {
                const b = document.createElement('button');
                b.className = "key-btn text-xl";
                b.innerText = n;
                b.onclick = () => {
                    if(state.userNum.length < 3) {
                        state.userNum += n;
                        document.getElementById('numeric-display').innerText = state.userNum;
                    }
                };
                keypad.appendChild(b);
            });
            const del = document.createElement('button');
            del.className = "key-btn text-red-500";
            del.innerText = "‚å´";
            del.onclick = () => {
                state.userNum = state.userNum.slice(0, -1);
                document.getElementById('numeric-display').innerText = state.userNum;
            };
            keypad.appendChild(del);
        }

        function renderVocabQuiz() {
            const ui = document.getElementById('quiz-ui');
            ui.innerHTML = '';
            state.vocabQ.opts.forEach(opt => {
                const b = document.createElement('button');
                b.className = "key-btn p-4 text-sm mb-1";
                b.innerText = opt;
                b.onclick = () => {
                    if(opt === state.vocabQ.a) success();
                    else fail("Wrong Term!");
                };
                ui.appendChild(b);
            });
        }

        function renderDiagramInput() {
            const grid = document.getElementById('orbital-diagram-grid');
            grid.innerHTML = '';
            const order = [ {n:"1s",c:1}, {n:"2s",c:1}, {n:"2p",c:3}, {n:"3s",c:1}, {n:"3p",c:3}, 
                            {n:"4s",c:1}, {n:"3d",c:5}, {n:"4p",c:3}, {n:"5s",c:1}, {n:"4d",c:5}, {n:"5p",c:3} ];
            state.diagram = [];
            
            const lastPart = getCorrectConfig(state.element.z, 'normal').parts.slice(-1)[0];
            const limit = orbitalKeys.indexOf(lastPart.label);

            order.forEach(grp => {
                if(orbitalKeys.indexOf(grp.n) > limit) return;
                const grpDiv = document.createElement('div');
                grpDiv.className = "flex flex-col items-center mx-1 mb-2";
                grpDiv.innerHTML = `<span class="text-[10px] font-bold text-slate-400 mb-1 uppercase">${grp.n}</span>`;
                const row = document.createElement('div');
                row.className = "flex gap-0.5 sm:gap-1";
                for(let i=0; i<grp.c; i++) {
                    const box = document.createElement('div');
                    box.className = "orbital-box";
                    const bObj = { count: 0 };
                    state.diagram.push(bObj);
                    box.onclick = () => {
                        bObj.count = (bObj.count + 1) % 3;
                        box.innerHTML = '';
                        if(bObj.count >= 1) box.innerHTML += '<span class="spin-arrow text-blue-500 relative -top-0.5">‚Üë</span>';
                        if(bObj.count === 2) box.innerHTML += '<span class="spin-arrow text-red-500 relative top-0.5">‚Üì</span>';
                    };
                    row.appendChild(box);
                }
                grpDiv.appendChild(row);
                grid.appendChild(grpDiv);
            });
        }

        function renderDiagramPreview(z) {
            const container = document.getElementById('diagram-preview');
            container.innerHTML = '';
            const order = [ {n:"1s",c:1}, {n:"2s",c:1}, {n:"2p",c:3}, {n:"3s",c:1}, {n:"3p",c:3}, 
                            {n:"4s",c:1}, {n:"3d",c:5}, {n:"4p",c:3}, {n:"5s",c:1}, {n:"4d",c:5}, {n:"5p",c:3} ];
            let electrons = z;
            order.forEach(grp => {
                if(electrons <= 0) return;
                const grpDiv = document.createElement('div');
                grpDiv.className = "flex flex-col items-center mx-0.5";
                grpDiv.innerHTML = `<span class="text-[8px] font-bold text-slate-300 mb-0.5">${grp.n}</span>`;
                const row = document.createElement('div');
                row.className = "flex gap-0.5";
                for(let i=0; i<grp.c; i++) {
                    const box = document.createElement('div');
                    box.className = "w-5 h-5 sm:w-6 sm:h-6 border border-slate-300 rounded flex justify-center items-center bg-white";
                    let count = 0;
                    if(electrons > 0) { count++; electrons--; }
                    if(electrons > 0 && (z <= 20 ? electrons >= (grp.c - i) : electrons >= (grp.c - i))) { 
                        if(z <= 20) {
                            if(electrons >= (grp.c - i)) { count++; electrons--; }
                        } else {
                             if(electrons >= (grp.c - i)) { count++; electrons--; }
                        }
                    }
                    if(count >= 1) box.innerHTML += '<span class="text-blue-500 text-[10px] sm:text-xs">‚Üë</span>';
                    if(count === 2) box.innerHTML += '<span class="text-red-500 text-[10px] sm:text-xs">‚Üì</span>';
                    row.appendChild(box);
                }
                grpDiv.appendChild(row);
                container.appendChild(grpDiv);
            });
        }

        function handleElementClick(el) {
            if(state.waitingNext) return;
            if(!state.mode.startsWith('identify') && !state.mode.startsWith('hunt')) return;
            
            let correct = false;
            if(state.mode.startsWith('hunt')) {
                if(state.targetCategory.z.includes(el.z)) { correct = true; state.element = el; }
            } else {
                if(el.z === state.element.z) correct = true;
            }

            if(correct) success();
            else fail("Wrong Element!");
        }

        document.getElementById('submit-btn').onclick = () => {
            if(state.waitingNext) return;
            let correct = false;

            if(state.mode === 'count_valence') {
                if(parseInt(state.userNum) === state.element.v) correct = true;
            } else if(state.mode === 'calc_neutrons') {
                if(parseInt(state.userNum) === state.isotopeNeutrons) correct = true;
            } else if(state.mode === 'build_diagram') {
                correct = state.diagram.reduce((a,b)=>a+b.count,0) === state.element.z;
            } else {
                const sol = getCorrectConfig(state.element.z, state.mode);
                const userStr = state.userParts.map(p => p.isNoble?p.label:`${p.label}${p.count}`).join(" ");
                const solStr = (sol.noble?sol.noble+" ":"") + sol.parts.map(p => `${p.label}${p.count}`).join(" ");
                if(userStr === solStr) correct = true;
            }

            if(correct) success();
            else fail("Try Again!");
        };

        function success() {
            clearInterval(state.timerId);
            state.waitingNext = true;
            state.streak++;
            state.score += 100 + (state.streak * 10);
            updateStats();
            showToast("Correct!", `Streak: ${state.streak}`, true);
            
            document.getElementById('input-area').classList.add('hidden');
            document.getElementById('identify-hint').classList.add('hidden');
            document.getElementById('info-panel').classList.remove('hidden');
            if(state.mode === 'vocab') {
                document.getElementById('info-title').innerText = "Correct!";
                document.getElementById('info-desc').innerText = "Excellent chemistry knowledge.";
            } else {
                document.getElementById('info-title').innerText = `${state.element.n} (${state.element.s})`;
                document.getElementById('info-desc').innerText = state.element.d;
            }
        }

        function revealAnswer(msg) {
            clearInterval(state.timerId);
            state.waitingNext = true;
            state.streak = 0;
            updateStats();
            showToast("Time's Up!", msg, false);

            document.getElementById('input-area').classList.add('hidden');
            document.getElementById('identify-hint').classList.add('hidden');
            document.getElementById('info-panel').classList.remove('hidden');

            let title = "";
            let desc = "";

            if (state.mode === 'vocab') {
                title = "Correct Answer:";
                desc = state.vocabQ.a;
            } else if (state.mode === 'count_valence') {
                title = `Correct Valence: ${state.element.v}`;
                desc = `${state.element.n} is in Group ${state.element.v > 2 ? state.element.v + 10 : state.element.v}.`;
            } else if (state.mode === 'calc_neutrons') {
                title = `Correct Neutrons: ${state.isotopeNeutrons}`;
                desc = `Mass (${state.element.z + state.isotopeNeutrons}) - Protons (${state.element.z}) = ${state.isotopeNeutrons}`;
            } else if (state.mode.startsWith('hunt')) {
                title = state.targetCategory.name;
                const symbols = state.targetCategory.z.map(z => {
                    const e = elements.find(el => el.z === z);
                    return e ? e.s : '';
                }).filter(s => s).join(", ");
                desc = `Correct elements: ${symbols}`;
            } else {
                title = `${state.element.n} (${state.element.s})`;
                const config = getCorrectConfig(state.element.z, 'short');
                const str = (config.noble ? config.noble + " " : "") + config.parts.map(p => `${p.label}<sup>${p.count}</sup>`).join(" ");
                desc = `<span class='block mb-2'>${state.element.d}</span><strong>Configuration:</strong><br>${str}`;
            }

            document.getElementById('info-title').innerText = title;
            document.getElementById('info-desc').innerHTML = desc;
        }

        function fail(msg) {
            state.streak = 0;
            updateStats();
            showToast("Incorrect", msg, false);
            const card = document.getElementById('prompt-card');
            card.classList.add('shake');
            setTimeout(() => card.classList.remove('shake'), 400);
        }

        function showToast(title, msg, isSuccess) {
            const t = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-msg').innerText = msg;
            icon.innerText = isSuccess ? "‚úì" : "‚úï";
            icon.className = `w-8 h-8 rounded-full flex items-center justify-center font-bold ${isSuccess?'bg-green-100 text-green-600':'bg-red-100 text-red-600'}`;
            t.classList.remove('toast-hidden');
            t.classList.add('toast-visible');
            setTimeout(() => { t.classList.remove('toast-visible'); t.classList.add('toast-hidden'); }, 1800);
        }

        function updateStats() {
            document.getElementById('streak-val').innerText = state.streak;
            document.getElementById('score-val').innerText = state.score;
            document.getElementById('level-val').innerText = state.level;
        }

        window.nextLevel = () => {
            // Apply Period Limit Filter
            let pool = elements;
            if(state.periodLimit === 3) pool = elements.filter(e => e.z <= 18);
            else if(state.periodLimit === 4) pool = elements.filter(e => e.z <= 36);
            
            state.element = pool[Math.floor(Math.random() * pool.length)];
            setMode(); 
        };

        window.resetInput = () => {
            state.userParts = [];
            state.userNum = "";
            document.getElementById('numeric-display').innerText = "";
            if(state.mode.startsWith('build_diagram')) renderDiagramInput();
            else if(state.mode.startsWith('build')) updateConfigDisplay();
        };

        window.onload = () => {
            renderPTable();
            setTimerDuration(30); 
        };
    </script>
</body>
</html>
