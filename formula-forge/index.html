<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formula Forge: Builder Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700&display=swap');

        :root {
            --bg-light: #f8fafc;
            --emerald-main: #10b981;
        }

        body {
            background-color: var(--bg-light);
            font-family: 'Outfit', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .periodic-grid {
            display: grid;
            grid-template-columns: repeat(18, minmax(0, 1fr));
            gap: 2px;
            background: #e2e8f0;
            padding: 4px;
            border-radius: 8px;
        }

        .elem-btn {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
            border-radius: 4px;
            transition: all 0.1s;
            cursor: pointer;
            background: white;
        }

        .elem-btn:hover { transform: scale(1.1); z-index: 10; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .elem-btn.metal { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
        .elem-btn.nonmetal { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        .elem-btn.metalloid { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
        .elem-btn.empty { background: transparent; pointer-events: none; border: none; }

        .poly-btn {
            width: 100%;
            text-align: left;
            padding: 8px 12px;
            border-radius: 8px;
            background: white;
            border: 1px solid #e2e8f0;
            margin-bottom: 4px;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .poly-btn:hover { border-color: var(--emerald-main); background: #f0fdf4; }

        .builder-slot {
            background: white;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            min-width: 140px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .builder-slot.active { border: 2px solid var(--emerald-main); border-style: solid; }

        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        #charge-overlay {
            backdrop-filter: blur(4px);
            background: rgba(255,255,255,0.8);
        }
    </style>
</head>
<body class="p-4">

    <nav class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-4">
        <div class="flex items-center gap-4">
            <div class="bg-emerald-500 text-white w-10 h-10 rounded-xl flex items-center justify-center font-bold text-xl">F</div>
            <div>
                <h1 class="font-black text-slate-800 leading-none">FORMULA FORGE</h1>
                <p class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest mt-1">Honors Builder Mode</p>
            </div>
        </div>
        <div class="flex gap-6 bg-slate-50 px-6 py-2 rounded-xl border border-slate-100">
            <div class="text-center">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Streak</p>
                <p id="streak" class="text-xl font-black text-amber-500">0</p>
            </div>
            <div class="text-center">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Score</p>
                <p id="score" class="text-xl font-black text-emerald-600">0</p>
            </div>
        </div>
    </nav>

    <div class="flex-grow grid grid-cols-12 gap-4 overflow-hidden">
        
        <div class="col-span-8 flex flex-col gap-4 overflow-hidden">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex-grow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Interactive Periodic Table</h3>
                    <div class="flex gap-4 text-[10px] font-bold">
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded bg-blue-100 border border-blue-200"></div> Metals</span>
                        <span class="flex items-center gap-1"><div class="w-2 h-2 rounded bg-red-100 border border-red-200"></div> Non-Metals</span>
                    </div>
                </div>
                <div id="periodic-table" class="periodic-grid">
                    </div>
            </div>

            <div class="bg-emerald-900 p-6 rounded-3xl shadow-xl flex flex-col gap-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xs font-bold text-emerald-400 uppercase tracking-widest">Construction Tray</h3>
                    <button onclick="clearTray()" class="text-[10px] text-white/50 hover:text-white underline uppercase">Reset Tray</button>
                </div>
                <div id="builder-tray" class="flex gap-4 items-center justify-center min-h-[140px]">
                    </div>
                <button onclick="checkFormula()" class="w-full bg-emerald-500 hover:bg-emerald-400 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-[0.98]">
                    VERIFY CHEMICAL STRUCTURE
                </button>
            </div>
        </div>

        <div class="col-span-4 flex flex-col gap-4 overflow-hidden">
            <div id="target-card" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-emerald-500 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-emerald-500"></div>
                <p class="text-[10px] font-bold text-emerald-500 uppercase tracking-tighter mb-1">Assemble this Compound:</p>
                <h2 id="target-name" class="text-2xl font-black text-slate-800 leading-tight">...</h2>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Honors Polyatomic Library</h3>
                </div>
                <div id="poly-list" class="flex-grow overflow-y-auto p-4 custom-scroll">
                    </div>
            </div>
        </div>
    </div>

    <div id="charge-overlay" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl border border-slate-200 text-center max-w-sm w-full">
            <p id="charge-title" class="text-xs font-bold text-slate-400 uppercase mb-4">Select Oxidation State for Iron</p>
            <div id="charge-options" class="grid grid-cols-2 gap-4">
                </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        // Polyatomics from Study List 
        const polyatomics = [
            { name: "Acetate", sym: "C2H3O2", charge: -1 },
            { name: "Hypochlorite", sym: "ClO", charge: -1 },
            { name: "Chlorite", sym: "ClO2", charge: -1 },
            { name: "Chlorate", sym: "ClO3", charge: -1 },
            { name: "Perchlorate", sym: "ClO4", charge: -1 },
            { name: "Nitrite", sym: "NO2", charge: -1 },
            { name: "Nitrate", sym: "NO3", charge: -1 },
            { name: "Permanganate", sym: "MnO4", charge: -1 },
            { name: "Hydroxide", sym: "OH", charge: -1 },
            { name: "Bromate", sym: "BrO3", charge: -1 },
            { name: "Iodate", sym: "IO3", charge: -1 },
            { name: "Cyanide", sym: "CN", charge: -1 },
            { name: "Cyanate", sym: "OCN", charge: -1 },
            { name: "Thiocyanate", sym: "SCN", charge: -1 },
            { name: "Dihydrogen Phosphate", sym: "H2PO4", charge: -1 },
            { name: "Bicarbonate", sym: "HCO3", charge: -1 },
            { name: "Bisulfite", sym: "HSO3", charge: -1 },
            { name: "Bisulfate", sym: "HSO4", charge: -1 },
            { name: "Sulfite", sym: "SO3", charge: -2 },
            { name: "Sulfate", sym: "SO4", charge: -2 },
            { name: "Thiosulfate", sym: "S2O3", charge: -2 },
            { name: "Chromate", sym: "CrO4", charge: -2 },
            { name: "Dichromate", sym: "Cr2O7", charge: -2 },
            { name: "Carbonate", sym: "CO3", charge: -2 },
            { name: "Oxalate", sym: "C2O4", charge: -2 },
            { name: "Peroxide", sym: "O2", charge: -2 },
            { name: "Hydrogen Phosphate", sym: "HPO4", charge: -2 },
            { name: "Arsenate", sym: "AsO4", charge: -3 },
            { name: "Borate", sym: "BO3", charge: -3 },
            { name: "Phosphite", sym: "PO3", charge: -3 },
            { name: "Phosphate", sym: "PO4", charge: -3 },
            { name: "Ammonium", sym: "NH4", charge: 1 },
            { name: "Mercury (I)", sym: "Hg2", charge: 2 } // Note: Hg2 is +2 (two Hg+ ions bonded)
        ];

        const elements = [
            { sym: "H", n: "Hydrogen", x: 1, y: 1, c: [1], t: "nonmetal" },
            { sym: "Li", n: "Lithium", x: 1, y: 2, c: [1], t: "metal" },
            { sym: "Na", n: "Sodium", x: 1, y: 3, c: [1], t: "metal" },
            { sym: "K", n: "Potassium", x: 1, y: 4, c: [1], t: "metal" },
            { sym: "Mg", n: "Magnesium", x: 2, y: 3, c: [2], t: "metal" },
            { sym: "Ca", n: "Calcium", x: 2, y: 4, c: [2], t: "metal" },
            { sym: "Ba", n: "Barium", x: 2, y: 6, c: [2], t: "metal" },
            { sym: "Fe", n: "Iron", x: 8, y: 4, c: [2, 3], t: "metal" },
            { sym: "Cu", n: "Copper", x: 11, y: 4, c: [1, 2], t: "metal" },
            { sym: "Ag", n: "Silver", x: 11, y: 5, c: [1], t: "metal" },
            { sym: "Zn", n: "Zinc", x: 12, y: 4, c: [2], t: "metal" },
            { sym: "Al", n: "Aluminum", x: 13, y: 3, c: [3], t: "metal" },
            { sym: "C", n: "Carbon", x: 14, y: 2, c: [-4], t: "nonmetal" },
            { sym: "N", n: "Nitrogen", x: 15, y: 2, c: [-3], t: "nonmetal" },
            { sym: "P", n: "Phosphorus", x: 15, y: 3, c: [-3], t: "nonmetal" },
            { sym: "O", n: "Oxygen", x: 16, y: 2, c: [-2], t: "nonmetal" },
            { sym: "S", n: "Sulfur", x: 16, y: 3, c: [-2], t: "nonmetal" },
            { sym: "F", n: "Fluorine", x: 17, y: 2, c: [-1], t: "nonmetal" },
            { sym: "Cl", n: "Chlorine", x: 17, y: 3, c: [-1], t: "nonmetal" },
            { sym: "Br", n: "Bromine", x: 17, y: 4, c: [-1], t: "nonmetal" },
            { sym: "I", n: "Iodine", x: 17, y: 5, c: [-1], t: "nonmetal" },
            { sym: "Pb", n: "Lead", x: 14, y: 6, c: [2, 4], t: "metal" },
            { sym: "Sn", n: "Tin", x: 14, y: 5, c: [2, 4], t: "metal" }
        ];

        // --- STATE ---
        let tray = [];
        let score = 0;
        let streak = 0;
        let currentTarget = null;

        // --- INITIALIZATION ---
        function initTable() {
            const container = document.getElementById('periodic-table');
            for(let y=1; y<=7; y++) {
                for(let x=1; x<=18; x++) {
                    const el = elements.find(e => e.x === x && e.y === y);
                    if(el) {
                        const btn = document.createElement('div');
                        btn.className = `elem-btn ${el.t}`;
                        btn.innerHTML = `<span>${el.sym}</span>`;
                        btn.onclick = () => selectElement(el);
                        container.appendChild(btn);
                    } else {
                        const empty = document.createElement('div');
                        empty.className = 'elem-btn empty';
                        container.appendChild(empty);
                    }
                }
            }
        }

        function initPolyList() {
            const list = document.getElementById('poly-list');
            polyatomics.forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'poly-btn';
                const superStr = p.charge > 0 ? `${Math.abs(p.charge)}+` : `${Math.abs(p.charge)}-`;
                btn.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold">${p.name}</span>
                        <span class="font-mono text-[10px] bg-slate-100 px-1.5 py-0.5 rounded">${p.sym}<sup>${superStr}</sup></span>
                    </div>
                `;
                btn.onclick = () => addToTray(p.sym, p.charge, true, p.name);
                list.appendChild(btn);
            });
        }

        // --- CORE LOGIC ---
        function selectElement(el) {
            if (el.c.length > 1) {
                showChargePicker(el);
            } else {
                addToTray(el.sym, el.c[0], false, el.n);
            }
        }

        function showChargePicker(el) {
            const overlay = document.getElementById('charge-overlay');
            const options = document.getElementById('charge-options');
            const title = document.getElementById('charge-title');
            
            title.innerText = `Select Charge for ${el.n}`;
            options.innerHTML = '';
            overlay.classList.remove('hidden');

            el.c.forEach(charge => {
                const btn = document.createElement('button');
                btn.className = 'bg-emerald-500 hover:bg-emerald-600 text-white font-black py-4 rounded-2xl text-xl shadow-md';
                btn.innerText = charge > 0 ? `+${charge}` : charge;
                btn.onclick = () => {
                    addToTray(el.sym, charge, false, el.n);
                    overlay.classList.add('hidden');
                };
                options.appendChild(btn);
            });
        }

        function addToTray(symbol, charge, isPoly, name) {
            if (tray.length >= 2) return;
            tray.push({ symbol, charge, isPoly, subscript: 1, name });
            renderTray();
        }

        function renderTray() {
            const container = document.getElementById('builder-tray');
            container.innerHTML = '';

            tray.forEach((item, index) => {
                const slot = document.createElement('div');
                slot.className = 'builder-slot active';
                
                // Display Formula
                let display = item.symbol.replace(/(\d+)/g, '<sub>$1</sub>');
                const chargeLabel = item.charge > 0 ? `+${item.charge}` : item.charge;
                
                slot.innerHTML = `
                    <button onclick="removeFromTray(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full text-xs font-bold">Ã—</button>
                    <div class="text-2xl font-black text-slate-800">${display}</div>
                    <div class="text-[10px] font-bold text-slate-400 mb-2 uppercase">${item.name} (${chargeLabel})</div>
                    <select onchange="updateSubscript(${index}, this.value)" class="bg-slate-100 text-[10px] font-bold px-2 py-1 rounded-lg outline-none border border-slate-200">
                        ${[1,2,3,4,5,6,7,8,9,10].map(n => `<option value="${n}" ${item.subscript == n ? 'selected' : ''}>Qty: ${n}</option>`).join('')}
                    </select>
                `;
                container.appendChild(slot);
            });

            // Add empty slots if needed
            for(let i=tray.length; i<2; i++) {
                const empty = document.createElement('div');
                empty.className = 'builder-slot';
                empty.innerHTML = `<span class="text-[10px] font-bold text-slate-300 uppercase tracking-widest">Select Ion</span>`;
                container.appendChild(empty);
            }
        }

        function updateSubscript(index, val) {
            tray[index].subscript = parseInt(val);
        }

        function removeFromTray(index) {
            tray.splice(index, 1);
            renderTray();
        }

        function clearTray() {
            tray = [];
            renderTray();
        }

        // --- GAME MECHANICS ---
        function generateProblem() {
            clearTray();
            const types = ['ionic', 'poly'];
            const type = types[Math.floor(Math.random() * types.length)];
            
            let cation, anion;

            if (type === 'ionic') {
                cation = elements.filter(e => e.t === 'metal')[Math.floor(Math.random() * elements.filter(e => e.t === 'metal').length)];
                anion = elements.filter(e => e.t === 'nonmetal')[Math.floor(Math.random() * elements.filter(e => e.t === 'nonmetal').length)];
                
                const cCharge = cation.c[Math.floor(Math.random() * cation.c.length)];
                const aCharge = Math.abs(anion.c[0]);
                
                const g = gcd(cCharge, aCharge);
                const cSub = aCharge / g;
                const aSub = cCharge / g;

                let name = cation.n;
                if (cation.c.length > 1) {
                    name += ` (${roman(cCharge)})`;
                }
                name += " " + anion.n.toLowerCase().replace(/ine$|ogen$|orus$|ur$/, "") + "ide";
                if (anion.sym === 'O') name = cation.n + " oxide";

                currentTarget = { name, cSym: cation.sym, cCharge, cSub, aSym: anion.sym, aCharge: -aCharge, aSub };
            } else {
                // Polyatomic Problem
                const isAmmonium = Math.random() > 0.8;
                if(isAmmonium) {
                    cation = polyatomics.find(p => p.name === "Ammonium");
                    anion = elements.filter(e => e.t === 'nonmetal')[Math.floor(Math.random() * 5)];
                } else {
                    cation = elements.filter(e => e.t === 'metal')[Math.floor(Math.random() * 10)];
                    anion = polyatomics[Math.floor(Math.random() * polyatomics.length)];
                }

                const cCharge = cation.c ? cation.c[Math.floor(Math.random() * cation.c.length)] : cation.charge;
                const aCharge = Math.abs(anion.c ? anion.c[0] : anion.charge);
                
                const g = gcd(cCharge, aCharge);
                currentTarget = { 
                    name: cation.name || cation.n, 
                    cSym: cation.sym, cCharge, cSub: aCharge/g,
                    aSym: anion.sym, aCharge: (anion.charge || anion.c[0]), aSub: cCharge/g
                };

                if (cation.c && cation.c.length > 1) currentTarget.name += ` (${roman(cCharge)})`;
                currentTarget.name += " " + (anion.name).toLowerCase();
            }

            document.getElementById('target-name').innerText = currentTarget.name;
        }

        function checkFormula() {
            if (tray.length < 2) return alert("Select both components first.");
            
            const [c, a] = tray;
            
            // Validate Logic
            const matchC = (c.symbol === currentTarget.cSym && c.charge === currentTarget.cCharge && c.subscript === currentTarget.cSub);
            const matchA = (a.symbol === currentTarget.aSym && a.charge === currentTarget.aCharge && a.subscript === currentTarget.aSub);
            
            if (matchC && matchA) {
                streak++;
                score += 100 * streak;
                alert("STABLE STRUCTURE CONFIRMED!");
                updateStats();
                generateProblem();
            } else {
                streak = 0;
                updateStats();
                alert("BONDING ERROR: Check your subscripts or oxidation states.");
            }
        }

        function updateStats() {
            document.getElementById('score').innerText = score;
            document.getElementById('streak').innerText = streak;
        }

        function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }
        function roman(n) { return ["", "I", "II", "III", "IV", "V"][n]; }

        window.onload = () => {
            initTable();
            initPolyList();
            generateProblem();
            renderTray();
        };
    </script>
</body>
</html>